---
title: "Redux-Toolkitã§ã€ŒA non-serializable value was detectedã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¨ãã®å¯¾å‡¦æ–¹æ³•"
emoji: "ğŸ©"
type: "tech"
topics: ["redux", "reduxtoolkit"]
published: true
published_at: "2022-01-17 10:07"
---

# 1. äº‹ä»¶ç™ºç”Ÿ

å‹‰å¼·ã§[Github issueã‚’å–å¾—ã™ã‚‹API](https://docs.github.com/en/rest/reference/issues)ã¨redux-toolkitã‚’ä½¿ã£ã¦issueæ¤œç´¢ã‚µã‚¤ãƒˆã‚’ä½œã£ã¦ã¾ã—ãŸã€‚

```javascript:fetchIssueList.ts
export const fetchIssueList = createAsyncThunk<Issue[], InputValues, ThunkAPI>(
  'issue/fetchIssueList', 
  async (getIssueListParam, { rejectWithValue }) => {
  try {
    const { data } = await getIssueList(getIssueListParam);
    return formatIssueList(data);
  } catch (error) {
    return rejectWithValue(error);
  }
});
```
```javascript:index.ts
useEffect(() => {
  dispatch(fetchIssueList({ owner, repository, page: currenPageNumber }));
}, [owner, repository, currenPageNumber, dispatch]);
```

ãã—ã¦**æ¤œç´¢çµæœãŒ0ä»¶ã®ã¨ã(=404ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ããŸã¨ã)ã€äº‹ä»¶ã¯èµ·ã“ã£ãŸ**ã®ã§ã™ã€‚

```text:ã‚¨ãƒ©ãƒ¼
A non-serializable value was detected in an action, in the path: `payload`. Value: Error: Request failed with status code 404
    at createError (createError.js:16:1)
    at settle (settle.js:17:1)
    at XMLHttpRequest.onloadend (xhr.js:66:1) 
Take a look at the logic that dispatched this action:  {type: 'issue/fetchIssueList/rejected', payload: Error: Request failed with status code 404
    at createError (http://localhost:3000/static/js/bundâ€¦, meta: {â€¦}, error: {â€¦}}
```

ã€Œaction ã® payload ã« non-serializable value ãŒæ¢çŸ¥ã•ã‚ŒãŸã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã§ã™ãŒæœ€åˆã©ã†ã„ã†æ„å‘³ã‹ã‚ˆãã‚ã‹ã‚‰ãšã€[Redux Style Guide](https://redux.js.org/style-guide/style-guide#do-not-put-non-serializable-values-in-state-or-actions)ã‚’æ¢ã£ã¦ã¿ã¾ã—ãŸã€‚


> **Avoid putting non-serializable values such as Promises, Symbols, Maps/Sets, functions, or class instances into the Redux store state or dispatched actions.** This ensures that capabilities such as debugging via the Redux DevTools will work as expected. It also ensures that the UI will update as expected.

store ã® stateã€dispatch ã™ã‚‹ action ã« non-serializable values ã‚’å…¥ã‚Œã‚‹ã“ã¨ã‚’é¿ã‘ã¦ãã ã•ã„ã¨æ›¸ã„ã¦ã¾ã™ã€‚

**ã§ã‚‚ãã‚“ãªã‚‚ã‚“å…¥ã‚Œã¦ã­ã‡ã( à²  à²  )ï¼Ÿï¼Ÿ** ã¨æ‚”ã—ã„æ°—æŒã¡ã«ãªã£ã¦åŸå› ã‚’èª¿ã¹ã¾ã—ãŸã€‚

# 2. åŸå› åˆ†æ

ã“ã®ã‚¨ãƒ©ãƒ¼ã¯`fetchIssueList`ãŒ`fulfilled`ã®ã¨ãã¯èµ·ããš`rejected`ã®ã¨ãã ã‘èµ·ããŸã®ã§ã¾ãšãã®ï¼’ã¤ã® action ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å‡ºåŠ›ã—ã¦ã¿ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/7a43a47e3e01-20220116.png)
*fulfilled action*

![](https://storage.googleapis.com/zenn-user-upload/3230dc1c74a4-20220116.png)
*rejected action*

ãŸã—ã‹ã«`payload`å€¤ã®è‰²ã‹ã‚‰é•ã„ã¾ã™ã­ã€‚`rejected`ã®`action.payload`ã‚‚å‡ºåŠ›ã—ã¦ã¿ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/8c0f273c2c72-20220116.png)
*action.payload*

æ­£ç›´ã“ã“ã§å¤§ä½“ã‚ã‹ã£ãŸæ°—ã«ã‚‚ãªã‚Šã¾ã™ãŒä¸€å¿œ`createError`ã®ä¸­èº«ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/03c941ffce24-20220116.png)

**ãªã‚‹ã»ã©ã€‚** `new Error`ã§ç”Ÿæˆã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ `payload` ã«å…¥ã£ã¦ãŸã‹ã‚‰ãã†ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¨ã„ã†æµã‚Œã§ã™ã€‚


# 3. è§£æ±ºæ–¹æ³•

## 3-1. serializableCheckã‚’å¤–ã™

æ¢ã—ãŸï¼‘ã¤ç›®è§£æ±ºæ¡ˆã¯`serializableCheck`è‡ªä½“ã‚’å¤–ã™ã“ã¨ã§ã™ã€‚[redux-toolkitå…¬å¼ã‚µã‚¤ãƒˆ](https://redux-toolkit.js.org/api/getDefaultMiddleware#customizing-the-included-middleware)ã‚’å‚è€ƒã«ã—ã¦æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚

```diff javascript:store.ts
const store = configureStore({
  reducer: rootReducer,
+  middleware: (getDefaultMiddleware) =>
+    getDefaultMiddleware({
+      serializableCheck: false,
+    }),
})
```

ã§ã‚‚ã“ã‚Œã ã¨ã™ã¹ã¦ã® state ã¨ action ã«å¯¾ã—ã¦`serializableCheck`ã‚’å¤–ã™ã“ã¨ã«ãªã‚‹ã®ã§ã€æœ¬å½“ã«å¿…è¦ãªéƒ¨åˆ†ã ã‘å¤–ã—ãŸã„æ°—æŒã¡ãŒã‚ã‚Šã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã‚¹ã‚³ãƒ¼ãƒ—ã‚’çµã‚Šã¾ã™ã€‚

ã‚„ã‚Šæ–¹ã¯[reduxå…¬å¼ã‚µã‚¤ãƒˆ](https://redux-toolkit.js.org/usage/usage-guide#working-with-non-serializable-data)ã«è¼‰ã£ã¦ã¾ã™ã€‚

```javascript:store.ts
configureStore({
  //...
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
        // Ignore these action types
        ignoredActions: ['your/action/type'],
        // Ignore these field paths in all actions
        ignoredActionPaths: ['meta.arg', 'payload.timestamp'],
        // Ignore these paths in the state
        ignoredPaths: ['items.dates'],
      },
    }),
})
```

action type ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•ã€action ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•ã€state ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹æ–¹æ³•ã®ï¼“ã¤ãŒã‚ã‚Šã¾ã™ã€‚

ç§ã®å ´åˆ state ã¯çµ¡ã‚“ã§ãªã„ã®ã§ä»¥ä¸‹ã®ï¼’ã¤ãŒä½¿ãˆã¾ã™ã€‚

```diff javascript:store.ts
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
+        ignoredActions: [
+          'issue/fetchIssueList/rejected', // ã“ã® action ã«å¯¾ã—ã¦ã¯ serializableCheck ã—ãªã„
+        ]
      },
    }),
```
```diff javascript:store.ts
  middleware: (getDefaultMiddleware) =>
    getDefaultMiddleware({
      serializableCheck: {
+        ignoredActionPaths: ['payload'] // action.payload ã«å¯¾ã—ã¦ã¯ serializableCheck ã—ãªã„
        ]
      },
    }),
```

ã“ã‚Œã‚’è¨­å®šã—ã¦ãŠãã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚

ã§ã™ãŒã€ã“ã®æ–¹æ³•ã¯æ¡ç”¨ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç†ç”±ã¯æ¬¡ã§è©±ã—ã¾ã™ã€‚

## 3-2. Error ã‚’ dispatch ã—ãªã„

ãã‚‚ãã‚‚ã®è©±ã§ã™ãŒã€**Error æœ¬ä½“ã‚’ dispatch ã—ãªã‘ã‚Œã°ã„ã„**ã¨ã„ã†ã“ã¨ã«ï¼ˆä»Šæ›´ï¼‰æ°—ã¥ãã¾ã—ãŸã€‚

`createAsyncThunk`ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã§ä½¿ã‚ã‚Œã¦ã‚‹`rejectWithValue`ã®å‹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```javascript
// rejectValue ã‚’ unknown ã«å®šç¾©ã—ã¦ãŸã®ã§ value ãŒ unknown ã«ãªã£ã¦ã‚‹
rejectWithValue: (value: unknown) => RejectWithValue<unknown, unknown>
```

ã“ã‚Œã ã‘ã ã¨æƒ…å ±ãŒè¶³ã‚Šãªã„ã®ã§`node_modules/@reduxjs/toolkit`ã«ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¦`RejectWithValue`ã‚‚ç¢ºèªã—ã¾ã™ã€‚

```javascript:createAsyncThunk.ts
class RejectWithValue<Payload, RejectedMeta> {
  /*
  type-only property to distinguish between RejectWithValue and FulfillWithMeta
  does not exist at runtime
  */
  private readonly _type!: 'RejectWithValue'
  constructor(
    public readonly payload: Payload, // Payload ã¯ rejectWithValue ã®ç¬¬ä¸€å¼•æ•°ã®å‹
    public readonly meta: RejectedMeta
  ) {}
}
```

è‰²ã€…ã‚ã‚Šã¾ã™ãŒã€**è¦ã¯`RejectWithValue`ã«ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦æ¸¡ã—ãŸã‚„ã¤ãŒ rejected action ã®`payload`ã«å…¥ã‚‹**ã¨ã„ã†ã“ã¨ã§ã—ã‚‡ã†ã€‚

ãã—ã¦ç§ã¯ï¼ˆä½•ã‚‚è€ƒãˆãšã«ï¼‰`rejectWithValue(error)`ã¨æ›¸ã„ã¦ãŸã®ã§ã€ã—ã£ã‹ã‚Š action ã« non-serializable value ã‚’çªã£è¾¼ã‚“ã§ãŸã¨ã„ã†ã“ã¨ã§ã™! ~~ãã‚“ãªã‚‚ã‚“å…¥ã‚Œã¦ã­ã‡ãã¨æ€ã£ã¦ãŸã®ãŒæ¥ãšã‹ã—ããªã£ãŸ~~

ã“ã“ã¾ã§ã‚ã‹ã£ãŸã‚‰è§£æ±ºã¯ç°¡å˜ã§ã™ã€‚

ã¾ãš payload ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(`string`)ã ã‘å…¥ã‚ŒãŸã„ã®ã§`rejectValue`ã®å‹ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```diff typescript:ThunkAPI.ts
export type ThunkAPI = {
  dispatch: AppDispatch;
-  rejectValue: unknown;
+  rejectValue: string;
  state: RootState;
};
```
+) ThunkAPI ã®å‹ãŒä½•ãªã®ã‹åˆ†ã‹ã‚‰ãªã„æ–¹ã¯ã“ã®è¨˜äº‹ã‚’ã”å‚è€ƒãã ã•ã„ã€‚
https://zenn.dev/luvmini511/articles/c9cdb77a145f4d

æ¬¡ã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¾ã™ã€‚catch æ–‡ã®ã‚¨ãƒ©ãƒ¼ã®å‹ã¯`unknown`ã«ãªã£ã¦ã‚‹ã®ã§ã€ãã“ã‹ã‚‰`string`ã‚’å–ã‚Šå‡ºã—ã¦è¿”ã™é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

```javascript:customizeError.ts
export const customizeError = (error: unknown): string => {
  if (error instanceof Error) return error.message;
  return 'æœªçŸ¥ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
};
```

ãã—ã¦`rejectWithValue`ã«å…¥ã‚Œã‚Œã°å®Œæˆï¼

```javascript:fetchIssueList.ts
export const fetchIssueList = createAsyncThunk<Issue[], InputValues, ThunkAPI>(
  'issue/fetchIssueList', 
  async (getIssueListParam, { rejectWithValue }) => {
  try {
    const { data } = await getIssueList(getIssueListParam);
    return formatIssueList(data);
  } catch (error) {
    return rejectWithValue(customizeError(error)); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(string)ã‚’ payload ã«å…¥ã‚Œã‚‹
  }
});
```

ã“ã‚Œã§`store.ts`ã®è¨­å®šè§¦ã‚‰ãšã«ã‚¨ãƒ©ãƒ¼è§£æ±ºã§ãã¾ã—ãŸã€‚ä½•ã‚‚è€ƒãˆãšã«ã‚³ãƒ¼ãƒ‰æ›¸ãã®ã‚„ã‚ã‚ã£ã¦ã„ã†è©±ã§ã™ã­^_^...

# 4.çµ‚ã‚ã‚Š

ã“ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚°ã‚°ã£ã¦ã¿ãŸã‚‰ action ã« timestamp ã‚’å…¥ã‚ŒãŸå ´åˆãŒã‚ˆãå‡ºã¦ãã¦ã€è§£æ±ºæ¡ˆã§`3-1. serializableCheckã‚’å¤–ã™`ã§ç´¹ä»‹ã—ãŸæ–¹æ³•ãŒæŒ™ã’ã‚‰ã‚Œã¦ã¾ã—ãŸã€‚

[ã€ŒDo Not Put Non-Serializable Values in State or Actionsã€](https://redux-toolkit.js.org/api/getDefaultMiddleware#customizing-the-included-middleware)ã«ã‚‚ **action ãŒ reducer ã«è‡³ã‚‹å‰ã« thunk ã¿ãŸã„ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«æ¸¡ã•ã‚Œã‚‹ã¨ãã¯ä¾‹å¤–**ã ã¨è¼‰ã£ã¦ã¾ã™ã®ã§ã€ãã†ã„ã†ã¨ãä½¿ãˆã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
> Exception: **you may put non-serializable values in actions if the action will be intercepted and stopped by a middleware before it reaches the reducers.** Middleware such as redux-thunk and redux-promise are examples of this.

ã§ã‚‚ [JSON.stringify()](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify)ã€[JSON.parse()](https://developer.mozilla.org/ko/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse) ã§å€¤ã‚’æ•´å½¢ã—ãŸã‚‰è§£æ±ºã§ããã†ãªæ°—ãŒã—ãŸã®ã§ã€ä»Šåº¦ãã†ã„ã†å ´é¢ã«å‡ºãã‚ã—ãŸã‚‰è©¦ã—ã¦ã¿ã¾ã™ã€‚

---

+)ä½™è«‡
2021å¹´é ‘å¼µã£ã¦æ›¸ã„ãŸè¨˜äº‹ã€æ€ã£ãŸã‚ˆã‚ŠãŸãã•ã‚“ã®æ–¹ã€…ãŒèª­ã‚“ã§ãã ã•ã£ã¦ãƒ“ãƒƒã‚¯ãƒªã—ã¾ã—ãŸï¼ï¼ï¼ **1å¹´é–“ãªã‚“ã¨ã‚µãƒãƒ¼ãƒˆãƒãƒƒã‚¸3! ã„ã„ã­1,318ï¼ ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼81,957!!!** 

![](https://storage.googleapis.com/zenn-user-upload/17c298b3fb0c-20220105.png =500x)
![](https://storage.googleapis.com/zenn-user-upload/f3f016d49f8e-20220105.png =500x)

æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™(Â´âŒ£`ÊƒÆª) ä»Šå¹´ã‚‚é ‘å¼µã‚Šã¾ã™ãƒ¼ï¼ï¼ï¼

