---
title: "createSlice ã§æ¥½ã« action ã¨ reducer ã‚’ç®¡ç†ã—ã‚ˆã†"
emoji: "ğŸ°"
type: "tech"
topics:
  - "react"
  - "typescript"
  - "redux"
  - "reduxtoolkit"
published: true
published_at: "2021-05-17 09:54"
---

## å§‹ã‚

redux-toolkit ã‚’è§¦ã£ã¦ã¿ã¦ã€`createSlice`ã§ action ã‚‚ reducer ã‚‚ä¸€ç·’ã«ç®¡ç†ã§ãã‚‹ã£ã¦ç´ æ•µãƒ¼ï¼ã¨æ€ã„ã¾ã—ãŸã€‚

## 1. Action

### 1-1. Reduxã®å ´åˆ

æ—¢å­˜ã® Reduxã§ã¯ action type å®šç¾©ã¨ action creator ä½œæˆã‚’åˆ¥ã€…ã§å®£è¨€ã—ã¦ã¾ã—ãŸã€‚
```typescript
//action type å®šç¾©
const INCREMENT = 'counter/increment'

//action creator ä½œæˆ
function increment(amount: number) {
  return {
    type: INCREMENT,
    payload: amount,
  }
}

const action = increment(3)
// { type: 'counter/increment', payload: 3 }
```

### 1-2. createAction

redux-toolkit ã§ã¯`createAction`ã‚’ä½¿ã£ã¦ action ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ 
- `createAction`ï¼š**action type ã‚’å¼•æ•°ã§å—ã‘å–ã£ã¦ã€ãã® type ã® action creator ã‚’è¿”ã™é–¢æ•°**

```typescript
const increment = createAction('counter/increment')

let action = increment()
// å¼•æ•°(payload)ãŒãªã„å ´åˆ
// è¿”ã‚Šå€¤ã¯ { type: 'counter/increment' }

action = increment(3)
// å¼•æ•°(payload)ãŒã‚ã‚‹å ´åˆ
// è¿”ã‚Šå€¤ã¯ { type: 'counter/increment', payload: 3 }
```

æ—¢å­˜ã® Redux ã§ã¯åˆ¥ã€…ã§ã‚„ã£ã¦ãŸã“ã¨ã‚’ä¸€å›ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã‚‚ã—`payload`ã‚’æ•´å½¢ã—ãŸã„ã¨ãã‚„ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ã—ãŸã„ã¨ãã¯`createAction`ã®ç¬¬2å¼•æ•°ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’æ¸¡ã—ã¾ã™ã€‚

```typescript
import { createAction, nanoid } from '@reduxjs/toolkit'

const addTodo = createAction('todos/add', function prepare(text: string) {
  return {
    payload: {
      text,
      id: nanoid(),
      createdAt: new Date().toISOString(),
    },
  }
})

console.log(addTodo('Write more docs'))
/**
 * {
 *   type: 'todos/add',
 *   payload: {
 *     text: 'Write more docs',
 *     id: '4AJvwMSWEHCchcWYga3dj',
 *     createdAt: '2019-10-03T07:53:36.581Z'
 *   }
 * }
 **/
```
action creator ãŒå—ã‘å–ã£ãŸå¼•æ•°`'Write more docs'`ãŒãã®ã¾ã¾ç¬¬2å¼•æ•°ã§ã‚ã‚‹`prepare`é–¢æ•°ã®å¼•æ•°ã«ãªã£ã¦ã¾ã™ã­ã€‚ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦`payload`ã®å½¢ã«æ‰‹ã‚’åŠ ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

*ã“ã®å ´åˆ return ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ Redux-toolkit ãŒæ±ºã‚ãŸ action ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ [Flux Standard Action](https://github.com/redux-utilities/flux-standard-action#flux-standard-action) ã«åˆã‚ã›ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚*


## 2. Reducer

### 2-1. Reduxã®å ´åˆ

æ—¢å­˜ã® Redux ã§ã¯ reducer ã‚’å®Ÿè£…ã™ã‚‹ã¨ã switch æ–‡ãªã©ã§ action type ã”ã¨ã«ã‚ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›¸ã„ã¦ã¾ã—ãŸã€‚ã‚ˆã default case ã‚’æ›¸ãå¿˜ã‚ŒãŸã‚Š initial state ã®è¨­å®šã‚’å¿˜ã‚ŒãŸã‚Šã—ã¾ã™ã­ã€‚

```typescript
const initialState = { value: 0 }

function counterReducer(state = initialState, action) {
  switch (action.type) {
    case 'increment':
      return { ...state, value: state.value + 1 }
    case 'decrement':
      return { ...state, value: state.value - 1 }
    default:
      return state
  }
}
```

### 2-2. createReducer

redux-toolkit ã® `createReducer`ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã« reducer é–¢æ•°ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import { createAction, createReducer } from '@reduxjs/toolkit'

interface CounterState {
  value: number
}

const increment = createAction('counter/increment')
const decrement = createAction('counter/decrement')

const initialState = { value: 0 } as CounterState

const counterReducer = createReducer(initialState, (builder) => {
  builder
    .addCase(increment, (state, action) => {
      state.value++
    })
    .addCase(decrement, (state, action) => {
      state.value--
    })
})
```

ï¼‘ç•ªç›®ç«‹ã¤éƒ¨åˆ†ã¯ **switch æ–‡ãŒãªããªã£ãŸã“ã¨**ï¼ã“ã‚Œã§ switch æ–‡åœ°ç„ã‹ã‚‰è„±å‡ºã—ã¾ã—ãŸã€‚

`createReducer`é–¢æ•°ã¯2ã¤ã®å¼•æ•°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
- ç¬¬1å¼•æ•°ï¼š**åˆæœŸå€¤**
- ç¬¬2å¼•æ•°ï¼š***builder* ã¨ã„ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•æ•°ã§å—ã‘å–ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°**

switch æ–‡ã®ä»£ã‚ã‚Šã« *builder* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ action ã”ã¨ã® reducer ã‚’ç”Ÿæˆã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚*builder* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¯3ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã™ã®ã§ã€ä¸€ã¤ãšã¤è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

**builder.addCase**

ç‰¹å®š action type ã® reducer ã‚’å®Ÿè£…ã™ã‚‹ã¨ãä½¿ã„ã¾ã™ã€‚switch æ–‡ã®`case`ã«è©²å½“ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã—ã‚‡ã†ã€‚

- ç¬¬1å¼•æ•°ï¼šaction type æ–‡å­—åˆ—ã‚‚ã—ãã¯`createAction`ã§ç”Ÿæˆã•ã‚ŒãŸ action creator
- ç¬¬2å¼•æ•°ï¼šç¬¬1å¼•æ•°ã® action ã«å¯¾ã™ã‚‹ reducer é–¢æ•°

**builder.addMatcher**

ã‚ã‚‹æ¡ä»¶ã«ãƒãƒƒãƒã™ã‚‹ action type ã® reducer ã‚’å®Ÿè£…ã™ã‚‹ã¨ãä½¿ã„ã¾ã™ã€‚

- ç¬¬1å¼•æ•°ï¼šmatcher é–¢æ•°
- ç¬¬2å¼•æ•°ï¼šç¬¬1å¼•æ•°ã® action ã«å¯¾ã™ã‚‹ reducer é–¢æ•°

```typescript
const initialState = {}
const reducer = createReducer(initialState, (builder) => {
  builder
    // .addCase(...)
    .addMatcher(
      (action) => action.type.endsWith('/rejected'),
      (state, action) => {
        state[action.meta.requestId] = 'rejected'
      }
    )
})
```

ã“ã®ä¾‹ã ã¨`/rejected`ã§çµ‚ã‚ã‚‹ action type ã«å¯¾ã™ã‚‹ reducer ã‚’å®Ÿè£…ã—ã¦ã¾ã™ã€‚

**builder.addDefaultCase**

ä¸Šè¨˜ã®2ã¤ã«ãƒãƒƒãƒã—ãªã‹ã£ãŸ action type ã® reducer ã‚’å®Ÿè£…ã™ã‚‹ã¨ãä½¿ã„ã¾ã™ã€‚switch æ–‡ã®default case ã¨ä¸€ç·’ã‹ã¨æ€ã„ã¾ã™ã€‚

- ç¬¬1å¼•æ•°ï¼šdefault case ã«å¯¾ã™ã‚‹ reducer é–¢æ•°

```typescript
const initialState = { otherActions: 0 }
const reducer = createReducer(initialState, (builder) => {
  builder
    // .addCase(...)
    // .addMatcher(...)
    .addDefaultCase((state, action) => {
      state.otherActions++
    })
})
```

ã¡ãªã¿ã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŸã¡ã¯å¿…ãš`addCase`â†’`addMatcher`â†’`addDefaultCase`ã®é †ã«æ›¸ã‹ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚ˆã†ã§ã™ã€‚


+)`createReducer`ã®ä½¿ã„æ–¹ã«ã¯ *builder* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨ã„ã‚‹æ–¹æ³•ä»¥å¤–ã« *Map* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚
```typescript
const increment = createAction('increment')
const decrement = createAction('decrement')

const counterReducer = createReducer(0, {
  [increment]: (state, action) => state + action.payload,
  [decrement.type]: (state, action) => state - action.payload
})
```

ã§ã™ãŒã€[Redux Toolkit å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://redux-toolkit.js.org/api/createReducer#usage-with-the-builder-callback-notation)ã§ã¯ Typescript ã¨ IDEs ã¨ã®ç›¸æ€§ã‚’ç†ç”±ã§ *builder* ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†æ–¹æ³•ã‚’ãŠã™ã™ã‚ã—ã¦ã„ã¾ã™ã€‚

> **The recommended way of using `createReducer` is the builder callback notation**, as it works best with TypeScript and most IDEs.


## 3.createSlice

### 3-1. Aciotn + Reducer â†’ Slice

ã¤ã„ã« slice ã¾ã§æ¥ã¾ã—ãŸãƒ¼ï¼ï¼

slice ã¨ã„ã†ã®ã¯ç°¡å˜ã«è¨€ã†ã¨ reducer é–¢æ•°ã¨ action creator ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

ä¸Šã§è¦‹ãŸ`createAction`ã¨`createReducer`ã‚’ä½¿ã‚ãªãã¦ã‚‚ã€`createSlice`ã‚’ä½¿ã£ãŸã‚‰ **reducer ã‚’ä½œæˆã™ã‚‹ã ã‘ã§è‡ªå‹•çš„ã« action type ã‚‚å®šç¾©ã—ã¦ãã‚Œã‚‹ã— action creator ã‚‚ç”Ÿæˆ**ã—ã¦ãã‚Œã¾ã™ã€‚ action ã¨ reducer ã‚’ä¸€ç™ºã§è§£æ±ºã§ãã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚

`createSlice`é–¢æ•°ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«1ã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™ã€‚
```typescript
function createSlice({
    //åç§°ï¼ˆaction type ã«ä½¿ã‚ã‚Œã‚‹ï¼‰
    name: string,
    //reducer ã®åˆæœŸå€¤
    initialState: any,
    //case reducer ãŸã¡ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    reducers: Object<string, ReducerFunction | ReducerAndPrepareObject>
    //åˆ¥ã§ä½œæˆã—ã¦ãŠã„ãŸ action ã«å¯¾ã™ã‚‹ reducerï¼ˆä»»æ„ï¼‰
    extraReducers?:
    | Object<string, ReducerFunction>
    | ((builder: ActionReducerMapBuilder<State>) => void)
})
```

ç°¡å˜ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚‚è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```typescript
import { createSlice, PayloadAction } from '@reduxjs/toolkit'

interface Item {
  id: string
  text: string
}

const todoSlice = createSlice({
  name: 'todos',
  initialState: [] as Item[],
  reducers: {
    addTodo: (state, action: PayloadAction<Item>) => {
      state.push(action.payload)
    },
  },
})

export const { addTodo } = todoSlice.actions
export default todoSlice.reducer
```

`reducers`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ reducer é–¢æ•°ã‚’ä½œæˆã—ãŸã‚‰ã€ãã® **key ã‹ã‚‰è‡ªå‹•çš„ã« action type ãŒç”Ÿæˆ**ã•ã‚Œã¾ã™ã€‚`name`ã¯ action type ã® prefix ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚ã“ã®ä¾‹ã ã¨ prefix ã¯`todos`ã§ã€action type ã¯`addTodo`ã«ãªã‚Šã¾ã™ã­ã€‚

`createAction`ã®ç¬¬2å¼•æ•°ã«æ¸¡ã—ã¦ãŸ`prepare`é–¢æ•°ã‚‚ã“ã“ã§ä½¿ãˆã¾ã™ã€‚`reducers`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆéƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ãŸã‚‰ã€`payload`ã‚’ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
reducers: {
    addTodo: {
      reducer: (state, action: PayloadAction<Item>) => {
        state.push(action.payload)
      },
      prepare: (text: string) => {
        const id = nanoid()
        return { payload: { id, text } }
      },
    },
  }
```

ã¾ãŸ`createAsyncThunk`ã§ç”Ÿæˆã—ãŸéåŒæœŸ action ãªã©ã€åˆ¥ã§ä½œæˆã—ã¦ãŠã„ãŸ action ã«å¯¾ã™ã‚‹ reducer ã‚’ä½œæˆã™ã‚‹ã¨ãã¯ `extraReducers`ã‚’ä½¿ã„ã¾ã™ã€‚

```typescript
const todoSlice = createSlice({
  name: 'todos',
  initialState: [] as Item[],
  reducers: {},
  extraReducers: (builder) => {
    builder
    .addCase(fetchUserById.pending, (state, action) => {
      //éåŒæœŸå‡¦ç†ä¸­ã®ãƒ­ã‚¸ãƒƒã‚¯
    })
    .addCase(fetchUserById.fulfilled, (state, action) => {
      //éåŒæœŸå‡¦ç†æˆåŠŸæ™‚ã®ãƒ­ã‚¸ãƒƒã‚¯
    })
    .addCase(fetchUserById.rejected, (state, action) => {
      //éåŒæœŸå‡¦ç†å¤±æ•—æ™‚ã®ãƒ­ã‚¸ãƒƒã‚¯
    })
  }
})
```
å¤–éƒ¨ã® action ã«å¯¾ã™ã‚‹ reducer é–¢æ•°ã‚’ä½œæˆã—ã¦ã„ã‚‹ã®ã§ã€`extraReducers`ã‹ã‚‰ã¯ action ãŒè‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã€‚

`extraReducers`ã®é–¢æ•°ã«ã¯`createReducer`ã®ç¬¬2å¼•æ•°ã¨åŒæ§˜ã«`builder.addCase`ä»¥å¤–ã«ã‚‚`builder.addMatcher`ã€`builder.addDefault`ã‚‚ä½¿ãˆã¾ã™ã€‚

ğŸ™‹ğŸ»â€â™€ï¸ *immer ã® produce API åˆ©ç”¨*
ã€€ä»Šã¾ã§ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒˆã§1ã¤ãŠã‹ã—ãªéƒ¨åˆ†ãŒã‚ã‚Šã¾ã—ãŸã€‚state ã‚’å¤‰æ›´ã™ã‚‹ã¨ã`push`ã‚’ä½¿ã†ãªã©ã€**immutable ã‚’å®ˆã£ã¦ãªã„**ã¨ã„ã†ã“ã¨ã§ã™ã€‚ãã‚Œã§ã‚‚å¤§ä¸ˆå¤«ãªç†ç”±ã¯ã€`createReducer`ã¨`createSlice`ãŒ**å†…éƒ¨çš„ã« [immer](https://immerjs.github.io/immer/) ã® produce API ã‚’ä½¿ã£ã¦ã„ã‚‹**ã‹ã‚‰ã§ã™ã€‚ãã®ãŠã‹ã’ã§ state ã‚’ç›´æ¥å¤‰æ›´ã—ã¦ã‚‚å‹æ‰‹ã« immutable ã‚’å®ˆã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¦è¿”ã—ã¦ãã‚Œã¾ã™ã€‚ã¨ã¦ã‚‚ä¾¿åˆ©ã«ãªã‚Šã¾ã—ãŸã­ã€‚
ã€€â†’immutable ã¨ immer ã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„ã‹ãŸã¯ã€Œ[ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãŒå¤§äº‹ãªç†ç”±ã€ãã—ã¦Immerã§ç°¡å˜å®Ÿç¾ï¼](https://zenn.dev/luvmini511/articles/85e8e3c71a2f41)ã€ã‚’ã”å‚è€ƒãã ã•ã„ã€‚


### 3-2. è¿”ã‚Šå€¤

å¼•æ•°ã‚’å—ã‘å–ã£ãŸ`createSlice`ã¯ã“ã®ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¾ã™ã€‚

```typescript
{
    name : string,
    reducer : ReducerFunction,
    actions : Record<string, ActionCreator>,
    caseReducers: Record<string, CaseReducer>
}
```

`reducer`ã«ã¯`reducers`ã¨`extraReducers`ã«ä½œæˆã—ãŸ reducer é–¢æ•°ãŸã¡ãŒã€`actions`ã«ã¯`reducers`ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸ action ãŸã¡ãŒã¾ã¨ã‚ã‚‰ã‚Œã¦ã¾ã™ã€‚

ãã—ã¦3-1ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒˆã®ã‚ˆã†ã«ã€**`slice.actions`ã‚’ export ã—ã¦å¿…è¦ãªã¨ã“ã‚ã§ä½¿ã†ã€`slice.reducer` ã‚’ export ã—ã¦ store ã®`combineReducers`ã§ã¾ã¨ã‚ã‚‹**ã€ã¨ã„ã†æµã‚Œã§ã™ã€‚

+) ã¡ãªã¿ã« "slice" ã¨ã„ã†åå‰ã«ãªã£ãŸã®ã¯ã€Œ`combineReducer`ã§ã¾ã¨ã‚ã‚‰ã‚ŒãŸ root reducer ã‚’æ§‹æˆã™ã‚‹1ã¤ã®ã‚¹ãƒ©ã‚¤ã‚¹(è–„ç‰‡)ã ã‹ã‚‰ã€ã¨ã„ã†ç†ç”±ã‚‰ã—ã„ã§ã™ã€‚


## çµ‚ã‚ã‚Š
æ€ã£ãŸã‚ˆã‚Šæ™‚é–“ã‹ã‹ã£ãŸãƒ¼ï¼action ã¨ reducer ã¨ã„ã†å˜èªè¦‹ã™ãã¦ã‚²ã‚·ãƒ¥ã‚¿ãƒ«ãƒˆå´©å£Šèµ·ã“ã—ãã†ã§ã™ç¬‘

ä½™è£•ãŒã‚ã£ãŸã‚‰ selector ã«ã¤ã„ã¦ã‚‚æ›¸ããŸã„ã§ã™ï¼