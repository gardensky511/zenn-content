---
title: "Reactã¨Google Maps: ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒãƒ¼ã‚«ãƒ¼ã® infoWindow ã ã‘è¡¨ç¤ºã•ã›ãŸã„"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["googlemap", "react", "nextjs", "javascript"]
published: true
---

## ğŸŒ¼ ã¯ã˜ã‚ã«

ã“ãªã„ã  google map ã‚’ä½¿ã†ã“ã¨ãŒã‚ã‚Šã€â†“ã®ã‚ˆã†ã«**ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒãƒ¼ã‚«ãƒ¼ã® infoWindow ã ã‘è¡¨ç¤º**ã•ã›ã‚‹å®Ÿè£…ã‚’ã‚„ã£ã¦ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/239244458fe8-20230813.gif)

ã“ã‚Œã‚’ã©ã†å®Ÿè£…ã™ã‚‹ã‹ããã£ã¦ã¿ã‚‹ã¨ã€å¤§ããï¼’ã¤ã®æ–¹æ³•ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚
1. ä»¥å‰ã® infoWindow ã‚’å–ã£ã¨ã„ã¦ã€æ–°ã—ã„ã‚‚ã®ã‚’é–‹ãã¨ãä»¥å‰ã®ã‚‚ã®ã‚’ close ã•ã›ã‚‹ï¼ˆ[å‚è€ƒ](https://stackoverflow.com/questions/2223574/google-maps-auto-close-open-infowindows)ï¼‰
2. infoWindow ã‚’ï¼‘ã¤ã ã‘ç”Ÿæˆã—ã€Markerã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãŸã³ã«ä¸­èº«ã‚’å¤‰ãˆã‚‹

ä»Šå›ã¯ï¼’ã®æ–¹æ³•ã§è§£æ±ºã§ããŸã®ã§ã€ãã‚Œã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã¡ãªã¿ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã¯`react-wrapper`ä½¿ã„ã¾ã—ãŸã€‚
https://github.com/googlemaps/react-wrapper

## 1. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

ã¾ãšã¯å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ä½œæˆã—ã¦ã„ãã¾ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆã¯ã»ã¼[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.google.com/maps/documentation/javascript/react-map?hl=ja)ã®ã‚³ãƒ”ãƒšã§ä½œæˆã§ãã‚‹ã®ã§ã€è©³ã—ã„èª¬æ˜ã¯å‰²æ„›ã—ã¾ã™ã€‚


### 1-1. Marker

ãƒ”ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã¿ãŸã„ãªã‚ã‚Œã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/707100c0d253-20230813.png)
*ã“ã‚Œ*

```ts:Marker.tsx
export const Marker = (options: google.maps.MarkerOptions) => {
  const [marker, setMarker] = useState<google.maps.Marker>()

  useEffect(() => {
    if (!marker) {
      setMarker(
        new google.maps.Marker({
          position: options.position,
        })
      )
    }

    // remove marker from map on unmount
    return () => {
      if (marker) {
        marker.setMap(null)
      }
    }
  }, [marker])

  useEffect(() => {
    if (marker) {
      marker.setOptions(options)
    }
  }, [marker, options])

  return null
}

```

ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã„ã¾ã™ãŒã€åˆ¥ã®ã‚¢ã‚¤ã‚³ãƒ³ã«ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ï¼ˆä½™åŠ›ã‚ã£ãŸã‚‰åˆ¥ã®è¨˜äº‹ã§æ›¸ãã¾ã™ï¼‰

### 1-ï¼’. Map

æ–‡å­—é€šã‚Šã€ã‚°ãƒ¼ã‚°ãƒ«ãƒãƒƒãƒ—ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚

```ts:Map.tsx
type MapProps = google.maps.MapOptions & {
  children: React.ReactNode
}

export const Map = ({ center, zoom, children }: MapProps) => {
  const ref = useRef<HTMLDivElement>(null)
  const [map, setMap] = useState<google.maps.Map>()

  useEffect(() => {
    if (ref.current && !map) {
      setMap(
        new window.google.maps.Map(ref.current, {
          center,
          zoom,
        })
      )
    }
  }, [ref, map])

  return (
    <>
      <div ref={ref} className={styles.map} />
      {Children.map(children, (child) => {
        if (isValidElement(child)) {
          // set the map prop on the child component
          // @ts-ignore
          return cloneElement(child, { map })
        }
      })}
    </>
  )
}
```

### 1-3. MapWrapper

ãƒãƒƒãƒ—ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚ã“ã“ã§APIã‚­ãƒ¼ãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€ãªã„æ–¹ã¯ä»¥ä¸‹ã‚’å‚è€ƒã«ç™ºè¡Œï¼†è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚

https://developers.google.com/maps/documentation/javascript/get-api-key?hl=ja

`stations`ã¨ã„ã†é…åˆ—ã«é§…ã®æƒ…å ±ãŒå…¥ã£ã¦ã‚‹ã®ã§ãã‚Œã‚’ãƒãƒ¼ã‚«ãƒ¼ã§è¡¨ç¤ºã•ã›ã¾ã—ãŸã€‚ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ã¯ç·¯åº¦çµŒåº¦æƒ…å ±ã¯å¿…é ˆã§ã™ã€‚

```ts:MapWrapper.tsx
type Station = {
  name: string
  description: string
  lat: number
  lng: number
}

type MapWrapperProps = {
  stations: Station[]
}

const CENTER = {
  lat: 35.68141044129315,
  lng: 139.767092618762,
}
const ZOOM = 10

export const MapWrapper = ({ stations }: MapWrapperProps) => {
  const apiKey = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY
  if (!apiKey) return null

  return (
    <Wrapper apiKey={apiKey}>
      <Map center={CENTER} zoom={ZOOM}>
        {stations.map(({ name, description, ...position }) => (
          <Marker key={name} position={position} />
        ))}
      </Map>
    </Wrapper>
  )
}
```

ã“ã“ã¾ã§ã‚„ã£ãŸã‚‰`stations`ã®é§…ãŸã¡ãŒãƒãƒ¼ã‚«ãƒ¼ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯è¨­å®šã—ã¦ãªã„ã®ã§ã€ã¾ã ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ãªã«ã‚‚èµ·ãã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/7c087e5315f4-20230813.png)

## 2. Markerã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 

ã§ã¯ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã¾ãšã¯[`.panTo(latLng)`](https://developers.google.com/maps/documentation/javascript/reference/map#Map.panTo)ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã€åœ°å›³ã®ä¸­å¿ƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒãƒ¼ã‚«ãƒ¼ã«ã€Œã‚¹ãƒ ãƒ¼ã‚ºã«ã€ç§»å‹•ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```diff ts:Marker.tsx
export const Marker = (options: google.maps.MarkerOptions) => {
  const [marker, setMarker] = useState<google.maps.Marker>()

+  marker?.addListener('click', () => {
+    if (options.map instanceof google.maps.Map) {
+      const position = marker.getPosition()
+      if (!!position) options.map.panTo(position)
+    }
+  })

  // ...
}
```

- `addListener`ã®ã¨ã“ã‚ãŒã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒã‚§ã‚¤ãƒ³ã«ãªã£ã¦ã‚‹ç†ç”±ã¯ã€`marker`ã®å‹ãŒ` google.maps.Marker | undefined`ã ã‹ã‚‰ã§ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒ`undefined`ãªã®ã§ï¼‰
- ã‚¿ã‚¤ãƒ—ã‚¬ãƒ¼ãƒ‰ã—ã¦ã‚‹ç†ç”±ã¯ã€`.panTo`ãƒ¡ã‚½ãƒƒãƒ‰ãŒ `google.maps.Map` å‹ã«ã ã‘å­˜åœ¨ã™ã‚‹ã®ã«`options.map` ã®å‹ãŒ `google.maps.Map | google.maps.StreetViewPanorama | null | undefined` ãªã£ã¦ã‚‹ã‹ã‚‰ã§ã™ã€‚ä»Šå›ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒˆãƒ“ãƒ¥ãƒ¼ä½¿ã†ã“ã¨ãªã„ã—ã€ã¾ã‚ã„ã„ã§ã—ã‚‡ã†ï¼


ã“ã‚Œã§ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰åœ°å›³ã®ä¸­å¿ƒãŒã‚¹ãƒ ãƒ¼ã‚ºã«å‹•ãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/bf77c169ea81-20230813.gif)

## 3. infoWindow ã‚’è¡¨ç¤ºã•ã›ã‚‹

ã§ã¯æœ¬é¡Œã§ã™ã€‚ä»Šå›ã®ã‚„ã‚Šæ–¹ã¯ã€ŒinfoWindow ã‚’ï¼‘ã¤ã ã‘ç”Ÿæˆã—ã€Markerã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãŸã³ã«ä¸­èº«ã‚’å¤‰ãˆã‚‹ã€ã§ã™ã€‚

infoWindow ã‚’ï¼‘ã¤ã ã‘ã«ã™ã‚‹ãŸã‚ã«ã¯ã€**Marker ã®è¦ªã§ infoWindow ã‚’ç”Ÿæˆã—ã¦ Marker ã«æµã™å¿…è¦ãŒã‚ã‚Šã¾ã™**ã€‚ï¼ˆMarker ã§å®šç¾©ã—ãŸã‚‰ Marker ã®æ•°åˆ† infoWindow ãŒã§ãã‚‹ã®ã§ï¼‰

ã¨ã„ã†ã“ã¨ã§ã€Marker ã®è¦ªã§ã‚ã‚‹ Map ã§ infoWindow ã‚’`useRef`ã§ç”Ÿæˆã—ã¾ã™ã€‚

```diff ts:Map.tsx
export const Map = ({ center, zoom, children }: MapProps) => {
  const ref = useRef<HTMLDivElement>(null)
  const [map, setMap] = useState<google.maps.Map>()
+  const infoWindowRef = useRef<google.maps.InfoWindow | null>(
+    new google.maps.InfoWindow({ maxWidth: 200 })
+  )

  // ...
  
  return (
    <>
      <div ref={ref} className={styles.map} />
      {Children.map(children, (child) => {
        if (isValidElement(child)) {
          // set the map prop on the child component
          // @ts-ignore
-	  return cloneElement(child, { map })
+         return cloneElement(child, { map, infoWindowRef })
        }
      })}
    </>
  )
}

```

`maxWidth`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ãŸã‚‰æœ€å¤§å¹…ã‚’æŒ‡å®šã§ãã¾ã™ã€‚ã“ã‚Œã¯ã©ã® infoWindow ã«ã‚‚é©ç”¨ã•ã›ãŸã„ã®ã§ã€ç”Ÿæˆæ™‚ã«ã¤ã‘ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

Map ã§ infoWindow ã‚’æµã™ã‚ˆã†ã«ã—ãŸã®ã§ã€Marker ã‚‚åˆã‚ã›ã¦ä¿®æ­£ã—ã¾ã™ã€‚propsã« infoWindow ã® ref ã¨ã€è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ã€€`station`ã€€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

```diff ts:Marker.tsx
+ type MarkerProps = google.maps.MarkerOptions & {
+   station: { name: string; description: string }
+   infoWindowRef?: MutableRefObject<google.maps.InfoWindow | null>
+ }

- export const Marker = (options: google.maps.MarkerOptions) => {
+ export const Marker = ({ station, infoWindowRef, ...options }: MarkerProps) => {
  const [marker, setMarker] = useState<google.maps.Marker>()
+ const infoWindowContent = `<div class="${styles.infoWindow}"><span class="${styles.name}">${station.name}</span><span class="${styles.description}">${station.description}</span></div>`

  marker?.addListener('click', () => {
    if (options.map instanceof google.maps.Map) {
      const position = marker.getPosition()
      if (!!position) options.map.panTo(position)
    }
    
+   if (infoWindowRef && infoWindowRef.current) {
+     infoWindowRef.current.setContent(infoWindowContent)
+     infoWindowRef.current.open({ map: options.map, anchor: marker })
+   }
  })

  // ...
}
```

- `infoWindowRef`ãŒã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªç†ç”±ã¯ã€MapWrapper ã§å‘¼ã³å‡ºã—ã¦ã‚‹ Marker ã§ã¯`infoWindowRef`ã‚’æ¸¡ã—ãŸããªã‹ã£ãŸã‹ã‚‰ã§ã™ï¼ˆMapã§ã‚‚ã†æµã—ã¦ã‚‹ã‹ã‚‰ï¼‰

`.setContent`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ãŸã‚‰ infoWindow å†…ã§è¡¨ç¤ºã™ã‚‹ä¸­èº«ã‚’è¨­å®šã§ãã¾ã™ã€‚æ–‡å­—åˆ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã«æ–‡å­—åˆ—ã§å›²ã‚“ã ã‚¿ã‚°ã‚‚è¨­å®šã§ãã¾ã™ã€‚ã“ã®å ´åˆã‚¿ã‚°ã«ã‚¯ãƒ©ã‚¹åã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã§ãã‚‹ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚

ä¸­èº«ã‚’è¨­å®šã—ãŸã®ã§ã€`.open`ãƒ¡ã‚½ãƒƒãƒ‰ã§ infoWindow ã‚’é–‹ãã¾ã™ã€‚ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã§[ã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://developers.google.com/maps/documentation/javascript/reference/info-window?hl=ja#InfoWindowOpenOptions)ãŒæŒ‡å®šã§ãã‚‹ã®ã§ã€`map`ã¨`anchor`ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚

ã§ã¯æœ€å¾Œã« MapWrapper ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æµã™ã‚ˆã†ã«ã—ãŸã‚‰å®Œæˆã§ã™ã€‚

```diff ts:MapWrapper.tsx
export const MapWrapper = ({ stations }: MapWrapperProps) => {
  // ...
  
  return (
    <Wrapper apiKey={apiKey}>
      <Map center={CENTER} zoom={ZOOM}>
        {stations.map(({ name, description, ...position }) => (
-         <Marker key={name} position={position} />
+         <Marker
+           key={name}
+           position={position}
+           station={{ name, description }}
+         />
        ))}
      </Map>
    </Wrapper>
  )
}
```

ã“ã‚Œã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ infoWindow ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã®æ–¹æ³•ã‚’ä½¿ã£ãŸã‚‰ä»¥å‰ã® infoWindow ã‚’å–ã£ã¨ã„ã¦é–‰ã˜ã‚‹å‡¦ç†ãŒè¦ã‚‰ãªããªã‚‹ã®ã§ã€çµæ§‹ã‚¹ãƒãƒ¼ãƒˆã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/239244458fe8-20230813.gif)

## 4. infoWindow ã‚’é–‹ã„ãŸã¾ã¾ã«ã—ãŸã„å ´åˆã¯

ã§ã¯é€†ã« infoWindow ã‚’é–‹ã„ãŸã¾ã¾ã«ã—ãŸã„å ´åˆã¯ã©ã†ã™ã‚Œã°ã„ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ç­”ãˆã¯ã¨ã¦ã‚‚ç°¡å˜ã§ã™ã€‚ä¸Šã§ã¡ã‚‰ã£ã¨è©±ã—ã¾ã—ãŸãŒã€**ãƒãƒ¼ã‚«ãƒ¼ã®æ•°åˆ† infoWindow ã‚’ç”Ÿæˆã™ã‚Œã°ã‚ˆã„**ã§ã™ã€‚ãã®ãŸã‚ã«ã¯ infoWindow ã‚’ Marker ã®è¦ªã§ç”Ÿæˆã—ã¦æµã™ã§ã¯ãªãã€Marker ã§ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```diff ts:Marker.tsx
type MarkerProps = google.maps.MarkerOptions & {
  station: { name: string; description: string }
- infoWindowRef?: MutableRefObject<google.maps.InfoWindow | null>
}

- export const Marker = ({ station, infoWindowRef, ...options }: MarkerProps) 
+ export const Marker = ({ station, ...options }: MarkerProps) => {
  const [marker, setMarker] = useState<google.maps.Marker>()
  const infoWindowContent = `<div class="${styles.infoWindow}"><span class="${styles.name}">${station.name}</span><span class="${styles.description}">${station.description}</span></div>`
+ const infoWindow = new google.maps.InfoWindow({
+   content: infoWindowContent,
+   maxWidth: 200,
+ })

  marker?.addListener('click', () => {
    if (options.map instanceof google.maps.Map) {
      const position = marker.getPosition()
      if (!!position) options.map.panTo(position)
    }
    
-   if (infoWindowRef && infoWindowRef.current) {
-     infoWindowRef.current.setContent(infoWindowContent)
-     infoWindowRef.current.open({ map: options.map, anchor: marker })
-   }
+   infoWindow.open({ã€€map: options.map,ã€€anchor: marker })
  })
  
  // ...
}

```

ã‚‚ã¡ã‚ã‚“ Map ã‹ã‚‰æµã—ã¦ãŸ infoWindowRef ã‚‚å‰Šé™¤ã—ã¾ã™ã€‚

```diff ts:Map.tsx
export const Map = ({ center, zoom, children }: MapProps) => {
  const ref = useRef<HTMLDivElement>(null)
  const [map, setMap] = useState<google.maps.Map>()
-  const infoWindowRef = useRef<google.maps.InfoWindow | null>(
-    new google.maps.InfoWindow({ maxWidth: 200 })
-  )

  // ...
  
  return (
    <>
      <div ref={ref} className={styles.map} />
      {Children.map(children, (child) => {
        if (isValidElement(child)) {
          // set the map prop on the child component
          // @ts-ignore
-         return cloneElement(child, { map, infoWindowRef })
+	  return cloneElement(child, { map })
        }
      })}
    </>
  )
}

```

ã“ã®æ–¹æ³•ã‚’ä½¿ã£ãŸã‚‰ã‚¯ãƒªãƒƒã‚¯ã—ãŸåˆ† infoWindowRef ã‚’é–‹ãã“ã¨ãŒã§ãã¾ã™ã€‚è¦ä»¶ã«åˆã†æ–¹ã§å®Ÿè£…ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

![](https://storage.googleapis.com/zenn-user-upload/bcf150090052-20230813.gif)

## ğŸŒ· çµ‚ã‚ã‚Š

æ–‡ç« ã§ã¾ã¨ã‚ãŸã‚‰ç°¡å˜ãªè§£æ±ºæ¡ˆã§ã™ãŒã€ã“ã“ã¾ã§ãŸã©ã‚Šç€ãã®ã«çµæ§‹æ™‚é–“ã‹ã‹ã£ã¦ã—ã¾ã„ã¾ã—ãŸã­ã€ã€ğŸ˜‡ ã‚„ã£ã±ä¸Šæ‰‹ãã„ã‹ãªã„ã¨ãã¯ã¨ã‚Šã‚ãˆãšå¯ã¦æ¬¡ã®æ—¥ã«æ–°é®®ãªé ­ã§è¦‹ãªã„ã¨
