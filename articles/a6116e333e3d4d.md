---
title: "Next.js App Routerã§å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’ãƒ¡ãƒ¢åŒ–ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs", "react"]
published: true
---

## ğŸŒ¼ ã¯ã˜ã‚ã«

Next.js Pages Router ã§ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ãŸã„å ´åˆ `getServerSideProps` ã‚„ `getStaticProps` ãªã©ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¤–ã®é–¢æ•°ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ¸¡ã™æ–¹å¼ã‚’å–ã£ã¦ã„ã¾ã—ãŸã€‚

ãã®åé¢ã€App Router ã‹ã‚‰ã¯ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ¡ç”¨ã€ãƒ‡ãƒ¼ã‚¿ã‚’å¿…è¦ã¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ãã†ã™ã‚‹ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å©ãã“ã¨ã‚‚èµ·ãã¾ã™ãŒã€[fetch API](https://nextjs.org/docs/app/api-reference/functions/fetch) ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹å ´åˆã¯ Next.js ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ãã‚Œã‚‹ã®ã§ã€åŒã˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½•åº¦ã‚‚é£›ã¶å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4303c682914e-20251110.png)
*https://nextjs.org/docs/app/guides/caching#request-memoization*

ã§ã‚‚å®Ÿéš›ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ axios ã‚„ prisma ãªã©å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ãŒã‚ˆãã‚ã‚Šã€ãã®å ´åˆã¯ Next.js ãŒãƒ¡ãƒ¢åŒ–ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚ãªã®ã§è‡ªåˆ†ã§ãƒ¡ãƒ¢åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãã‚Œã‚’ã©ã†ãƒ¡ãƒ¢åŒ–ã™ã‚‹ã‹ã‚’3ã¤ã®æ–¹æ³•ã§å®Ÿé¨“ã—ã¦ã¿ãŸã®ã§ã€å…±æœ‰ã—ã¾ã™ã€‚


## 1. React `cache`

ã¾ãšæœ€åˆã®æ–¹æ³•ã¯ React ãŒæä¾›ã™ã‚‹ [`cache`](https://react.dev/reference/react/cache) é–¢æ•°ã‚’ä½¿ã†æ–¹æ³•ã§ã™ã€‚

`cache` ã¯ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚„è¨ˆç®—ã®çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãã‚Œã‚‹é–¢æ•°ã§ã€ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ã¿ä½¿ãˆã¾ã™ã€‚ãã®`cache` ã‚’ä½¿ã£ã¦åŒã˜ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ãƒ¡ãƒ¢åŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚


ã¾ãšå¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆä»Šå›ã¯ axios ä½¿ç”¨ï¼‰ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹é–¢æ•°ã‚’ `cache` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

```typescript:getPostCached.ts
export const getPostCached = cache(async (id: number) => {
  const { data } = await axios.get(`https://jsonplaceholder.typicode.com/posts/${id}`);
  const execId = crypto.randomUUID(); // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Ÿè¡Œã™ã‚‹åº¦ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDç”Ÿæˆ
  return { ...data, id: execId };
});
```

æœ¬å½“ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãã‚‹ã‹ã©ã†ã‹ã‚’ç›®ã§ç¢ºèªã™ã‚‹ãŸã‚ã«ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã³ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå ´åˆ ID ãŒå¤‰ã‚ã‚‰ãªã„ã¯ãšï¼‰

ãã—ã¦åŒã˜ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’è¡Œã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’3ã¤ç”¨æ„ã—ã¾ã™ã€‚

```tsx:ComponentA.tsx
export const ComponentA = async () => {
  const post = await getPostCached(1);
  return (
    <>
      <pre>A: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```
```tsx:ComponentB.tsx
export const ComponentB = async () => {
  const post = await getPostCached(1);
  return (
    <>
      <pre>B: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```
```tsx:ComponentC.tsx
export const ComponentC = async () => {
  const post = await getPostCached(1);
  return (
    <>
      <pre>C: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```

æœ€å¾Œã«å…ˆã®3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ `page.tsx` ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚

```tsx:page.tsx
export default function Page() {
  return (
    <>
      <h2>1. react cache</h2>
      <Suspense>
        <ComponentA />
        <ComponentB />
        <ComponentC />
      </Suspense>
    </>
  );
}
```

ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¦ã¿ã‚‹ã¨3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå…¨éƒ¨åŒã˜IDã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹ã€ã¤ã¾ã‚Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/7ca1b9860354-20251109.png)


1ã¤æ³¨æ„ç‚¹ã¯å¼•æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—ã§ã™ã€‚`cache` ã§ãƒ¡ãƒ¢åŒ–ã•ã‚ŒãŸé–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã¯å¼•æ•°ã‚’è¦‹ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ãŒã€ãã®æ™‚æµ…ã„æ¯”è¼ƒï¼ˆShallow Comparisonï¼‰ã—ã¾ã™ã€‚

ãªã®ã§å¼•æ•°ãŒãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã§ã¯ãªã„å ´åˆã€ãƒ¡ãƒ¢ãƒªã‚¢ãƒ‰ãƒ¬ã‚¹åŒå£«ã®æ¯”è¼ƒã«ãªã‚‹ã®ã§**åˆ¥ã€…ã§ç”Ÿæˆã—ãŸå¼•æ•°ã‚’æ¸¡ã—ãŸã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã‹ãªããªã‚Šã¾ã™**ã€‚

ç¢ºèªã®ãŸã‚ã« `fetchPost` ã®å¼•æ•°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰ãˆã¦ã¿ã¾ã—ãŸï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ–¹ã‚‚è¦ä¿®æ­£ï¼‰ã€‚

```ts:axiosClient.ts
// å¼•æ•°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹
export const fetchPost = async ({ id }: { id: number }) => {
  // ...
};
```

ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¦ã¿ã‚‹ã¨ ID ãŒå…¨éƒ¨é•ã†ã€ã¤ã¾ã‚Šãƒ¡ãƒ¢åŒ–ã§ãã¦ãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c7d9fdecfb02-20251109.png)

ã“ã®äº‹æ…‹ã‚’é˜²ããŸã‚ã« `cache` ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹å ´åˆã¯å¼•æ•°ã‚’ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã«ã™ã‚‹ã‹ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¾ãŸã€`cache` ã¯åŒä¸€å‡¦ç†ã®é‡è¤‡å®Ÿè¡Œã‚’é¿ã‘ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹åº¦ã«æ–°ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯èµ°ã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/74d72c0e29a3-20251109.gif)
*ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹åº¦ã« ID ãŒå¤‰ã‚ã‚‹*

ã§ã™ã®ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¿…è¦ãªå ´åˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’5åˆ†é–“ç¶™ç¶šã•ã›ãŸã„ãªã©ï¼‰ã¯ `cache` ã¯é©åˆ‡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

é€†ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä¸è¦ã§åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ã‚’é™¤å»ã—ãŸã„ã ã‘ãªã‚‰ `cache` ãŒ1ç•ªæ‰‹ã£å–ã‚Šæ—©ã„ã¨æ€ã„ã¾ã™ã€‚

## 2. `'use cache'`

2ã¤ç›®ã®æ–¹æ³•ã¯ Next.js ãŒæä¾›ã™ã‚‹ [`'use cache'`](https://nextjs.org/docs/app/api-reference/directives/use-cache) ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½¿ã†æ–¹æ³•ã§ã™ã€‚`'use cache'` ã‚’ä½¿ã†ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚„é–¢æ•°ã€ãƒ«ãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãã¾ã™ã€‚

`'use cache'` ã‚’ä½¿ã†ãŸã‚ã«ã¯ Cache Components æ©Ÿèƒ½ã‚’ã‚ªãƒ³ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹^[`cacheComponents: true` ã«ã™ã‚‹ã¨ã€ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸­ã«æœªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã§å¾…ã¡ãŒç™ºç”Ÿã—å¾—ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä¸Šä½ã« Suspense ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚https://nextjs.org/docs/app/getting-started/cache-components?utm_source=chatgpt.com#missing-suspense-boundaries]ã®ã§ã€`next.config.ts` ã« `cacheComponents: true` ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts:next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  cacheComponents: true, // è¿½åŠ 
};

export default nextConfig;
```

ãã‚Œã‹ã‚‰å…ˆã¨åŒã˜ããƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹é–¢æ•°ã‚’ä½œã‚Šã€`'use cache'` ã‚’å…¥ã‚Œã¦é–¢æ•°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚

```ts:getPostCached.ts
export const getPostCached = async (id: number) => {
  'use cache';
  const { data } = await axios.get(`https://jsonplaceholder.typicode.com/posts/${id}`);
  const execId = crypto.randomUUID();ã€€// ãƒ‡ãƒ¼ã‚¿å–å¾—å®Ÿè¡Œã™ã‚‹åº¦ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDç”Ÿæˆ
  return { ...data, id: execId };
};
```

ã¾ãŸå…ˆã¨åŒã˜ãã€åŒã˜ãƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’3ã¤ç”¨æ„ã—ã¾ã™ã€‚

```tsx:ComponentA.tsx
export const ComponentA = async () => {
  const post = await getPostCached(2);
  return (
    <>
      <pre>A: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```
```tsx:ComponentB.tsx
export const ComponentB = async () => {
  const post = await getPostCached(2);
  return (
    <>
      <pre>B: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```
```tsx:ComponentC.tsx
export const ComponentC = async () => {
  const post = await getPostCached(2);
  return (
    <>
      <pre>C: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```

ãã—ã¦ãã®3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ `page.tsx` ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚

```tsx:page.tsx
export default function Page() {
  return (
    <>
      <h2>2. &#39;use cache&#39;</h2>
      <Suspense>
        <ComponentA />
        <ComponentB />
        <ComponentC />
      </Suspense>
    </>
  );
}
```

ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¦ã¿ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/056c8e7d9e4f-20251109.png)

`'use cache'` ã¯ `cache` ã¨é•ã£ã¦å¼•æ•°ã‚’æµ…ã„æ¯”è¼ƒã™ã‚‹ã®ã§ã¯ãªãã€**å¼•æ•°ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ãŸå€¤ã‚’æ¯”è¼ƒ**ã—ã¾ã™ã€‚

è©¦ã—ã«ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã®å¼•æ•°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰ãˆã¦ã¿ã¾ã—ãŸï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ–¹ã‚‚è¦ä¿®æ­£ï¼‰ã€‚

```ts:getPostCached.ts
// å¼•æ•°ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹
export const getPostCached = async ({ id }: { id: number }) => {
  'use cache';
  // ...
};
```

ã“ã®ã¾ã¾ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¦ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€ç›¸å¤‰ã‚ã‚‰ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c95fc5b9d62b-20251110.png)


ã“ã“ã§ãµã¨ã€Œå¼•æ•°ã‚’ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã—ã¦æ¯”è¼ƒã™ã‚‹ãªã‚‰ã€å¼•æ•°ãŒ `{id:2,text:"A"}` ã¨ `{text:"A",id:2}` ã®ã‚ˆã†ã«**ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®é †åºãŒé•ã†ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ã‹ãªã„ã®ã§ã¯ï¼Ÿ**ã€ã¨æ€ã„ã€è©¦ã—ã¦ã¿ãŸã‚‰**æœ¬å½“ã«åŠ¹ã„ã¦ãªã‹ã£ãŸ**ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/689a47097927-20251110.png)
*`ComponentA` ã ã‘å¼•æ•°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£é †åºå¤‰ãˆã¦ã¿ãŸ*

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£é †åºã¨ã‹ã„ã¡ã„ã¡æ°—ã«ã—ã¦ã‚‰ã‚Œãªã„ã®ã§ã€ã‚„ã¯ã‚Šãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã®å¼•æ•°ã«ã—ãŸã»ã†ãŒã„ã„æ°—ãŒã—ã¾ã™ã€‚

ã¾ãŸã€`'use cache'` ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`'use cache'` ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¯¿å‘½ã¯15åˆ†ãªã®ã§ã€ãã®é–“ã¯ä½•å›ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ãšã£ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒä½¿ã‚ã‚Œã¾ã™ã€‚ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¿å‘½ã¯ [cacheLife](https://nextjs.org/docs/app/api-reference/functions/cacheLife) ã§èª¿æ•´ã§ãã‚‹ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/958e21092c39-20251109.gif)
*ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ ID ãŒå¤‰ã‚ã‚‰ãªã„*

åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã®é‡è¤‡ã‚’é¿ã‘ã¤ã¤ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¾ãŸã„ã§çµæœã‚‚ä½¿ã„å›ã—ãŸã„ãªã‚‰ `'use cache'` ãŒã„ã„ã§ã—ã‚‡ã†ã€‚ãŸã ã— Cache Components æ©Ÿèƒ½ã‚’ã‚ªãƒ³ã«ã™ã‚‹ã¨ Suspense å¢ƒç•ŒãŒå¿…é ˆã«ãªã‚Šã‚„ã™ã„ãªã©ã€Cache Components æ©Ÿèƒ½ã®ãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã‚‹ã®ã§ãã®ç†è§£ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

ãªãŠ Cache Components ã¯ Next.js v15 ã¾ã§ã¯ experimental ã§ã—ãŸãŒã€[v16ï¼ˆ2025/10/21ï¼‰](https://nextjs.org/blog/next-16#cache-components)ã‹ã‚‰æ­£å¼æ©Ÿèƒ½ã«ãªã‚Šã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚

## 3. Route Handlers + fetch

æœ€å¾Œã¯ Route Handlers ã§ Next.js ã§ API ã‚’ä½œã‚Šã€ãã® API ã‚’ fetch ã§å©ãæ–¹æ³•ã§ã™ã€‚ã“ã®æ–¹æ³•ã ã¨ã€Œã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€â†’ã€ŒRoute Handlersã€â†’ã€Œå¤–éƒ¨APIã€ã¨ã„ã†æµã‚Œã«ãªã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å‘¼ã¶ `fetch('/api/â€¦')` ã¯ Next.js ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ãƒ¢åŒ–ãŒå‹•ããŸã‚ã€åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡ã¯é™¤å»ã•ã‚Œã¾ã™ã€‚

å®Ÿé¨“ã®ãŸã‚ã« `app/api` é…ä¸‹ã§ API ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```ts:app/api/posts/[id]/route.ts
export async function GET(_req: NextRequest, { params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const postId = parseInt(id, 10);

  const { data } = await axios.get(`https://jsonplaceholder.typicode.com/posts/${postId}`);
  const execId = crypto.randomUUID(); // ãƒ‡ãƒ¼ã‚¿å–å¾—å®Ÿè¡Œã™ã‚‹åº¦ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDç”Ÿæˆ

  return NextResponse.json({ ...data, id: execId });
}
```

ãã—ã¦ä»Šã¾ã§é€šã‚ŠåŒã˜ãƒ‡ãƒ¼ã‚¿å–å¾—ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’3ã¤ç”¨æ„ã—ã¾ã™ã€‚

```tsx:ComponentA.tsx
export const ComponentA = async () => {
  const response = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/posts/${3}`);
  const post = await response.json();
  return (
    <>
      <pre>A: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```
```tsx:ComponentB.tsx
export const ComponentB = async () => {
  const response = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/posts/${3}`);
  const post = await response.json();
  return (
    <>
      <pre>B: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```
```tsx:ComponentC.tsx
export const ComponentC = async () => {
  const response = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/posts/${3}`);
  const post = await response.json();
  return (
    <>
      <pre>C: {post.title}</pre>
      <div>ID: {post.id}</div>
    </>
  );
};
```

ãã®3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ `page.tsx` ã§å‘¼ã³å‡ºã—ã¾ã™ã€‚

```tsx:page.tsx
export default function Page() {
  return (
    <>
      <h2>3. Route Handlers + fetch</h2>
      <Suspense>
        <ComponentA />
        <ComponentB />
        <ComponentC />
      </Suspense>
    </>
  );
}
```

ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã—ã¦ã¿ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c93d3497e3fb-20251109.png)

Route Handlers + fetch ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§ãã¾ã™ã€‚`revalidate` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¿å‘½è¨­å®šã§ãã‚‹ã®ã§ã€`ComponentA` ã ã‘ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å¯¿å‘½ã‚’30ç§’ã«è¨­å®šã—ã¦ã¿ã¾ã—ãŸã€‚

```tsx:ComponentA.tsx
export const ComponentA = async () => {
  const response = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/posts/${3}`, {
    next: { revalidate: 30 }, // å¯¿å‘½ã‚’30ç§’ã«è¨­å®š
  });
  const post = await response.json();
  return (
    <>
      <pre>A: {post.title}</pre>
      <div>ID: {post.id} (30ç§’é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥)</div>
    </>
  );
};
```

ã“ã‚Œã§ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€`ComponentA` ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/04e6c9cb72c2-20251109.gif)
*`ComponentA` ã ã‘ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ ID ãŒå¤‰ã‚ã‚‰ãªã„*

Route Handlers + fetch ã‚‚åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®é‡è¤‡é™¤å» + ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è·¨ã„ã ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã§ãã‚‹ã—ã€API ã‚’ã‚‚ã†ä¸€ã¤å®Ÿè£…ã™ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§ HTTP ãƒ¬ã‚¤ãƒ¤ã§å…±é€šå‡¦ç†ãŒå¿…è¦ãªå ´åˆã¯é©åˆ‡ã ã¨æ€ã„ã¾ã™ã€‚ãŸã  API ãŒã‚‚ã†1ã¤å¢—ãˆã‚‹åˆ†é…å»¶ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚


## ğŸŒ· çµ‚ã‚ã‚Š

ã‚„ã¯ã‚Šè¨­è¨ˆã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã¨ã„ã†ã“ã¨ã‚’è€ƒãˆã‚‹è¨˜äº‹ã§ã—ãŸã€‚

ã“ã®è¨˜äº‹ã§ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ã¯ github ã«ã‚ã’ã¦ã¾ã™ï¼ˆå®Ÿé¨“ç”¨ãªã®ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¨ã‹çµæ§‹é©å½“ã§ã™ï¼‰ã€‚ã‚‚ã—æ°—ã«ãªã‚‹æ–¹ã¯ç›´æ¥è§¦ã£ã¦ã¿ã¦ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
https://github.com/gardensky511/nextjs-cache-lab