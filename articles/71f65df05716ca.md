---
title: "Next.js ã§ Hydration Error ãŒèµ·ãã‚‹ç†ç”±ã¨è§£æ±ºæ–¹æ³•"
emoji: "âœ¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nextjs","react"]
published: true
---

# ğŸŒ¼ ã¯ã˜ã‚ã«

æœ€è¿‘ä»•äº‹ã§ Next.jsï¼ˆapp routerï¼‰ã‚’è§¦ã£ã¦ã¦ã€ã“ã†ã„ã†ã‚¨ãƒ©ãƒ¼ã«å‡ºä¼šã„ã¾ã—ãŸã€‚

> Error: Text content does not match server-rendered HTML.
> Warning: Text content did not match. Server: {sever text} Client: {client text}

ä»Šå›ã®è¨˜äº‹ã§ã¯ãªãœã“ã†ã„ã†ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ã®ã‹ã€ãã—ã¦ã©ã†è§£æ±ºã™ã‚Œã°è‰¯ã„ã‹ã‚’è§£èª¬ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚


# Hydration ã¨ã¯

SSRã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§JavaScriptãŒå…¨ã¦ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è¡Œã†ã®ã§ã¯ãªãã€ã‚µãƒ¼ãƒãƒ¼å´ã§äº‹å‰ã«é™çš„ãªHTMLã‚’ç”Ÿæˆã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚ŠåˆæœŸè¡¨ç¤ºã‚’é«˜é€ŸåŒ–ã§ãã¾ã™ãŒã€HTMLã ã‘ã‚’é€ä¿¡ã—ãŸæ®µéšã§ã¯ã¾ã ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒã§ãã¾ã›ã‚“ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ã€ã€ä½•ã‚‚èµ·ããªã„ã€ã€ï¼ï¼‰

HTMLã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸå¾Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§JavaScriptã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ã™ã§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹HTMLã«çµã³ã¤ã‘ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ã“ã®**é™çš„ãª HTML ã« Javascript ã‚’çµã³ã¤ã‘ã¦ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ Hydration ã¨ã„ã„ã¾ã™**ã€‚

Hydration ã¯ã€Œæ°´åˆ†è£œçµ¦ã€ã¨ã„ã†æ„å‘³ã®è‹±å˜èªãªã®ã§ã€ä¹¾ç‡¥ã—ã¦ã‚‹ HTML ã« JavaScript ã‚’æµã—ã¦ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ã¨æ€ã£ãŸã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚


# Hydration Error ã®ä¾‹

Hydration ãŒä½•ãªã®ã‹åˆ†ã‹ã£ãŸã®ã§ã€ã±ã±ã£ã¨ Hydration Error ã‚’å†ç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
`localStorage`ã«ç‰¹å®šã®å€¤ãŒã‚ã‚‹å ´åˆã¨ãªã„å ´åˆã§æ–‡è¨€ã‚’åˆ†ã‘ã‚‹ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã‚’æº–å‚™ã—ã¾ã—ãŸã€‚

```tsx:ClientComponent
"use client";

import { useEffect } from "react";

type ClientComponentProps = {
  name: string;
};

export const ClientComponent = ({ name }: ClientComponentProps) => {
  const hasVisited =
    typeof window !== "undefined" && !!localStorage.getItem("hasVisited");

  useEffect(() => {
    if (!hasVisited) localStorage.setItem("hasVisited", "true");
  }, []);

  const text = hasVisited ? "ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™" : "ã¯ã˜ã‚ã¾ã—ã¦";

  return (
    <span>
      {text}ã€{name}ã•ã‚“
    </span>
  );
};
```

`ClientComponent`ã®ãƒ—ãƒªãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆé™çš„HTMLç”Ÿæˆï¼‰ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡Œã‚ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šã€window ã‚„ localStorage ãªã©ã®ã‚¦ã‚§ãƒ– API ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚

ã—ãŸãŒã£ã¦ã€`typeof window !== "undefined"`ãŒ `true` ãªã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚ã‚Šã€`localStorage`ã®å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚`false` ãªã‚‰ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚ã‚‹ãŸã‚ã€`false` ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¾ã™ã€‚*ã“ã®ã‚¬ãƒ¼ãƒ‰ã‚’ã—ãªã„ã¨ã€ã‚µãƒ¼ãƒãƒ¼å´ã§`localStorage`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã€å‚ç…§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™*ã€‚

ã¨ã„ã†ã“ã¨ã¯ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯çµ¶å¯¾ã«"ã¯ã˜ã‚ã¾ã—ã¦"ã¨ã„ã†æ–‡è¨€ã§HTMLã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã—ã‹ã—ã€ã‚‚ã—ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§`localStorageã®`å€¤ãŒ`true`ã ã£ãŸå ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯`"ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™"`ã¨ã„ã†æ–‡è¨€ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã“ã§ã€**ã‚µãƒ¼ãƒãƒ¼å´ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ãƒ†ã‚­ã‚¹ãƒˆã«å·®ãŒç”Ÿã˜ã‚‹**ãŸã‚ã€Hydration Error ãŒç™ºç”Ÿã—ã¾ã™ã€‚ã€ŒText content does not match server-rendered HTMLã€ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã“ã®çŠ¶æ³ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã—ã¦ã¿ã‚‹ã¨ã€é™çš„ãªHTMLã§ã¯ä¸€ç¬`"ã¯ã˜ã‚ã¾ã—ã¦"`ãŒè¡¨ç¤ºã•ã‚Œã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã® JavaScript ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨`"ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™"`ã«å¤‰ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚


![](https://storage.googleapis.com/zenn-user-upload/84d17b86f8a3-20231018.gif)


ğŸ”” å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ã¯ code sandbox ã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚(2å›é–‹ã‹ãªã„ã¨ã‚¨ãƒ©ãƒ¼èµ·ããªã„ã§ã™ãŒç¬‘)

@[codesandbox](https://codesandbox.io/embed/hydration-error-sample-jgqq9t?fontsize=14&hidenavigation=2&theme=dark)

# è§£æ±ºæ–¹æ³•

ã§ã¯ã©ã†ã™ã‚Œã° Hydration Error ã‚’è§£æ±ºã§ãã‚‹ã‹è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®åˆæœŸå€¤ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã«åˆã‚ã›ã‚‹

æ–¹æ³•1ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§æœ€åˆã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ã§ã™ã€‚é©åˆ‡ãªå€¤ã«å¤‰æ›´ã™ã‚‹ã®ã¯ãã®å¾Œã«è¡Œã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€**Hydrationã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚µãƒ¼ãƒãƒ¼å´ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒä¸€è‡´ã—ã€ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã**ã“ã¨ãŒã§ãã¾ã™ã€‚

`useState`ã¨`useEffect`ã§ã“ã®å‹•ä½œã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```tsx:
export const ClientComponent = ({ name }: ClientComponentProps) => {
  const hasVisited =
    typeof window !== "undefined" && !!localStorage.getItem("hasVisited");

  // ã‚µãƒ¼ãƒãƒ¼å´ã§ã€Œã¯ã˜ã‚ã¾ã—ã¦ã€ã§ pre-render ã™ã‚‹ãŸã‚ã€åˆæœŸå€¤ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã«åˆã›ã‚‹
  const [text, setText] = useState("ã¯ã˜ã‚ã¾ã—ã¦")
  useEffect(() => {
    if (!hasVisited) localStorage.setItem("hasVisited", "true");
    else setText("ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™")
  }, []);

  return (
    <span>
      {text}ã€{name}ã•ã‚“
    </span>
  );
};
```

ä¸€ç¬`"ã¯ã˜ã‚ã¾ã—ã¦"`ãŒè¦‹ãˆã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã® JavaScript ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨`"ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™"`ã«å¤‰ã‚ã‚‹ã“ã¨ã¯å…ˆã¨åŒã˜ã§ã™ãŒã€ Hydration Error ã¯æ¶ˆãˆã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

å€‹äººçš„ã«å¤§ä½“ã®å ´åˆã“ã‚Œã§è§£æ±ºã§ãã‚‹ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚

## è©²å½“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘ SSR ã‚’ã•ã›ãªã„

æ–¹æ³•2ã¯ã€`next/dynamic`ã‚’ä½¿ã£ã¦è©²å½“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ SSR ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚**SSR ã‚’è¡Œã‚ãªã„å ´åˆã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã™ã¹ã¦ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒè¡Œã‚ã‚Œã‚‹ãŸã‚ã€Hydration è‡ªä½“ãŒç™ºç”Ÿã›ãšã€Hydration Error ã‚‚ç™ºç”Ÿã—ãªããªã‚‹**ã§ã—ã‚‡ã†ã€‚

`next/dynamic`ã¯ Lazy Loading ã®å®Ÿè£…æ–¹æ³•ã®ä¸€ã¤ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯è©³ã—ã„èª¬æ˜ã¯çœç•¥ã—ã¾ã™ã®ã§ã€å…¬å¼ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚’ã”å‚ç…§ãã ã•ã„ã€‚
https://nextjs.org/docs/app/building-your-application/optimizing/lazy-loading

ã§ã¯ dynamic import ã®ãŸã‚ã«æ–‡è¨€ãŒå¤‰ã‚ã‚‹ã¨ã“ã‚ã ã‘`Text`ã¨ã„ã†åˆ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ‡ã‚Šå‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ãƒ­ã‚¸ãƒƒã‚¯ã¯æœ€åˆã®ã¨ãã¨ä¸€ç·’ã§ã™ã€‚

```tsx:Text
import { useEffect } from "react";

export const Text = () => {
  const hasVisited =
    typeof window !== "undefined" && !!localStorage.getItem("hasVisited");

  useEffect(() => {
    if (!hasVisited) localStorage.setItem("hasVisited", "true");
  }, []);

  const text = hasVisited ? "ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™" : "ã¯ã˜ã‚ã¾ã—ã¦";

  return <span>{text}</span>;
};
```

ãã®å¾Œ`next/dynamic`ã‚’ä½¿ã£ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚SSRã‚’ã‚ªãƒ•ã«ã™ã‚‹ã®ã‚‚å¿˜ã‚Œãªã„ã‚ˆã†ã«ã€‚

```tsx:ClientComponent
"use client";

import dynamic from "next/dynamic";

const Text = dynamic(() => import("./Text").then((mod) => mod.Text), {
  ssr: false,
});

type ClientComponentProps = {
  name: string;
};

export const ClientComponent = ({ name }: ClientComponentProps) => {
  return (
    <span>
      <Text />
      <span>ã€{name}ã•ã‚“</span>
    </span>
  );
};
```

ã“ã‚Œã§ Hydration Error ãŒè§£æ±ºã§ãã¾ã—ãŸã€‚


â—ï¸â—ï¸**æ³¨æ„ç‚¹**â—ï¸â—ï¸

ç‰¹å®šã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã ã‘ SSR ã‚’ã‚ªãƒ•ã«ã—ãŸã‚‰ãã“ã ã‘ pre-render ã•ã‚Œãªã„ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«UIãŒä½•ã‚‚ãªã„çŠ¶æ…‹ã§æ€¥ã«ã±ã£ã¨å‡ºã¦ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/27f644e75e53-20231018.gif)

ã§ã™ã®ã§ã€**ã“ã®æ–¹æ³•ã¯ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã§è¦‹ãˆã‚‹ä½ç½®ã®UIã«ä½¿ã†ã“ã¨ã¯ãŠã™ã™ã‚ã§ãã¾ã›ã‚“**ã€‚ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã§è¦‹ãˆãªã„UIã‚„ã€æœ€åˆã¯éè¡¨ç¤ºã§ã‚¯ãƒªãƒƒã‚¯ãƒ»ãƒ›ãƒ¼ãƒãƒ¼ãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹UIã«ä½¿ã†ã“ã¨ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚


## `suppressHydrationWarning` ã§ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç„¡è¦–ã™ã‚‹

ä¸–ã®ä¸­ã«ã¯ã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã¨ããŒã„ã¤ã‚‚ã‚ã‚Šã¾ã™ã€‚

æœ¬å½“ã«ã©ã†ã«ã‚‚ãªã‚‰ãªã„å ´åˆã¯`suppressHydrationWarning={true}`ã§ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’é»™ã‚‰ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx:ClientComponent
export const ClientComponent = ({ name }: ClientComponentProps) => {
  const hasVisited =
    typeof window !== "undefined" && !!localStorage.getItem("hasVisited");

  useEffect(() => {
    if (!hasVisited) localStorage.setItem("hasVisited", "true");
  }, []);

  const text = hasVisited ? "ã¾ãŸä¼šãˆã¦å¬‰ã—ã„ã§ã™" : "ã¯ã˜ã‚ã¾ã—ã¦";

  return (
    // Hydration ã®ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ç„¡è¦–ã™ã‚‹
    <span suppressHydrationWarning>
      {text}ã€{name}ã•ã‚“
    </span>
  );
};
```

`suppressHydrationWarning`ã¯ Next.js å›ºæœ‰ã®æ©Ÿèƒ½ã§ã¯ãªãã€`div`ãªã©æ™®é€šã® React è¦ç´ ã«æ¸¡ã›ã‚‹ props ã§ã™ã€‚
https://react.dev/reference/react-dom/client/hydrateRoot#suppressing-unavoidable-hydration-mismatch-errors

ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã®ãŸã‚ã® props ãªã®ã§ã€æœ¬å½“ã«ã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã¨ãã ã‘ä½¿ã„ã¾ã—ã‚‡ã†ã€‚

ã¡ãªã¿ã«1éšå±¤ã¾ã§æœ‰åŠ¹ãªã®ã§ã€Hydration Error ãŒèµ·ãã¦ã‚‹è©²å½“è¦ç´ ã«ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚è©¦ã—ã«`span`å…¥ã‚Œã¦ï¼’éšå±¤ã«ã—ã¦ã¿ãŸã‚‰ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆãªããªã‚Šã¾ã—ãŸã€‚

```tsx:ClientComponent
// ...

return (
  // ï¼’éšå±¤ä¸Šã®è¦ç´ ã«ä»˜ã‘ã¦ã‚‹ã®ã§æœ‰åŠ¹ã«ãªã£ã¦ãªã„
  <span suppressHydrationWarning>
    <span>
      {text}ã€{name}ã•ã‚“
    </span>
  </span>
);
```


# ğŸŒ· çµ‚ã‚ã‚Š

ã“ã‚Œã§ Hydration Error ã«ã¤ã„ã¦ç†è§£ã§ãã¾ã—ãŸã€‚ä»Šå›ã®è¨˜äº‹ã®ã»ã¨ã‚“ã©ã¯ Next.js ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã¾ã™ã€‚

https://nextjs.org/docs/messages/react-hydration-error

ä»Šå›ç´¹ä»‹ã—ãŸç¾è±¡ä»¥å¤–ã«ã‚‚ã€ã‚¿ã‚°ã®ãƒã‚¹ãƒˆé–¢ä¿‚ãŒæ­£ã—ããªã„å ´åˆï¼ˆpã‚¿ã‚°ã®ä¸­ã«pã‚¿ã‚°ãŒã‚ã‚‹ã¨ã‹ï¼‰ãªã©ã‚‚ Hydration Error ãŒèµ·ãã‚‹åŸå› ã¨ãªã‚‹ã‚‰ã—ã„ã®ã§ã€ã¡ã‚ƒã‚“ã¨ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’æŠŠæ¡ã—ã¦ã‹ã‚‰å¯¾å¿œã™ã‚‹ã“ã¨ãŒå¤§äº‹ã ã¨æ€ã„ã¾ã™ã€‚